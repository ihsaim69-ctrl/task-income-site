<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script type="module">
    import { app } from "./firebase.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) window.location.href = "login.html";
      else {
        document.getElementById("userEmail").innerText = user.email;
        const snap = await getDoc(doc(db, "users", user.uid));
        document.getElementById("balance").innerText = snap.exists() ? snap.data().balance : 0;
      }
    });

    document.getElementById("earnBtn").addEventListener("click", async () => {
      const user = auth.currentUser;
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      const bal = snap.data().balance + 10;
      await updateDoc(ref, { balance: bal });
      document.getElementById("balance").innerText = bal;
    });

    document.getElementById("withdrawBtn").addEventListener("click", async () => {
      const user = auth.currentUser;
      const amount = parseInt(prompt("Enter amount to withdraw:"));
      if (!amount || amount <= 0) return alert("Invalid amount!");

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      const bal = snap.data().balance;

      if (amount > bal) return alert("Not enough balance!");

      await addDoc(collection(db, "withdrawRequests"), {
        userId: user.uid,
        email: user.email,
        amount,
        status: "Pending",
        time: new Date()
      });

      await updateDoc(ref, { balance: bal - amount });
      document.getElementById("balance").innerText = bal - amount;

      alert("Withdraw request sent!");
    });

    document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));
  </script>
</head>
<body>
  <h2>Dashboard</h2>
  <p>Logged in as: <span id="userEmail"></span></p>
  <p>Balance: <span id="balance"></span> coins</p>

  <button id="earnBtn">Complete Task (+10)</button>
  <button id="withdrawBtn">Withdraw</button>
  <button id="logoutBtn">Logout</button>
</body>
</html>