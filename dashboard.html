<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Task Income</title>
  <style>
    :root{--bg:#071228;--card:#0f2b3b;--accent:#06b6d4}
    body{font-family:Arial;color:#fff;background:var(--bg);margin:0;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center}
    .card{background:var(--card);padding:12px;border-radius:10px;margin-top:12px}
    button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#012;}
    input{padding:8px;border-radius:6px;border:none;background:#07202b;color:#fff}
    .muted{color:#9fb7bf;font-size:14px}
  </style>
</head>
<body>
  <header>
    <h2 id="welcome">Welcome</h2>
    <div>
      <button id="adminBtn" style="margin-right:8px;background:#fde68a;color:#042">Admin</button>
      <button id="logoutBtn" style="background:#ef4444">Logout</button>
    </div>
  </header>

  <div class="card">
    <div class="muted">Balance</div>
    <h1 id="bal">0</h1>
    <div class="muted">Points: <span id="points">0</span></div>
  </div>

  <div class="card">
    <h3>Quick Tasks</h3>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="taskProfile">Profile Complete (+10)</button>
      <button id="taskShare">Share (+15)</button>
    </div>
  </div>

  <div class="card">
    <h3>Invest / Withdraw</h3>
    <div style="margin-top:8px">
      <input id="investAmt" type="number" placeholder="Invest amount" style="width:160px;margin-right:8px" />
      <button id="investBtn">Invest</button>
    </div>
    <div style="margin-top:12px">
      <input id="withdrawAmt" type="number" placeholder="Withdraw amount" style="width:160px;margin-right:8px" />
      <button id="withdrawReqBtn">Request Withdraw</button>
    </div>
    <p class="muted" id="notice">Withdraw will be reviewed by admin.</p>
  </div>

  <div class="card">
    <h3>History</h3>
    <div id="history"></div>
  </div>

  <script type="module">
    import {
      auth, db, onAuthStateChanged, signOut,
      doc, getDoc, updateDoc, addDoc, collection, query, where, getDocs, serverTimestamp
    } from "./firebase.js";

    let currentUserUid = null;

    onAuthStateChanged(auth, async user => {
      if(!user) return location.href = "index.html";
      currentUserUid = user.uid;
      document.getElementById('welcome').innerText = 'Hi, ' + (user.email || 'User');
      await refreshUser();
      loadHistory();
    });

    async function refreshUser(){
      const uref = doc(db, 'users', currentUserUid);
      const snap = await getDoc(uref);
      if(!snap.exists()){
        await setDefaultUser();
        return refreshUser();
      }
      const data = snap.data();
      document.getElementById('bal').innerText = (data.balance || 0);
      document.getElementById('points').innerText = (data.points || 0);
    }

    async function setDefaultUser(){
      await setDoc(doc(db, 'users', currentUserUid), { email: auth.currentUser.email, balance:0, points:0, role:'user', createdAt: serverTimestamp() });
    }

    // Task buttons
    document.getElementById('taskProfile').addEventListener('click', ()=> earn(10,'Profile complete'));
    document.getElementById('taskShare').addEventListener('click', ()=> earn(15,'Share social'));

    async function earn(amount,note){
      // update user balance and write transaction
      const uRef = doc(db,'users', currentUserUid);
      const uSnap = await getDoc(uRef);
      const old = (uSnap.data()?.balance||0);
      await updateDoc(uRef,{ balance: old + amount, points: (uSnap.data()?.points||0)+amount });
      await addDoc(collection(db,'transactions'), { userId: currentUserUid, amount, type:'earn', note, createdAt: serverTimestamp() });
      await refreshUser();
      alert('Earned ' + amount + '৳');
      loadHistory();
    }

    // Invest (for demo we just increase "investments" count and reduce balance)
    document.getElementById('investBtn').addEventListener('click', async ()=>{
      const amt = parseFloat(document.getElementById('investAmt').value);
      if(!amt || amt<=0) return alert('Enter amount');
      const uRef = doc(db,'users', currentUserUid);
      const uSnap = await getDoc(uRef);
      const bal = (uSnap.data()?.balance||0);
      if(amt > bal) return alert('Not enough balance');
      // create investment record
      await addDoc(collection(db,'investments'), { userId: currentUserUid, amount: amt, createdAt: serverTimestamp(), status:'active' });
      await updateDoc(uRef, { balance: bal - amt });
      await addDoc(collection(db,'transactions'), { userId: currentUserUid, amount: amt, type:'invest', note:'invested', createdAt: serverTimestamp() });
      await refreshUser(); loadHistory();
      alert('Invested ' + amt + '৳');
    });

    // Withdraw request
    document.getElementById('withdrawReqBtn').addEventListener('click', async ()=>{
      const amt = parseFloat(document.getElementById('withdrawAmt').value);
      if(!amt || amt<=0) return alert('Enter valid amount');
      const uRef = doc(db,'users', currentUserUid);
      const uSnap = await getDoc(uRef);
      const bal = (uSnap.data()?.balance||0);
      if(amt > bal) return alert('Not enough balance');
      // create request
      await addDoc(collection(db,'withdrawRequests'), { userId: currentUserUid, email: auth.currentUser.email, amount: amt, status: 'pending', createdAt: serverTimestamp() });
      // do NOT immediately deduct — we will deduct after admin approves; but for UX you may optionally deduct here:
      // await updateDoc(uRef, { balance: bal - amt });
      alert('Withdraw request sent');
      loadHistory();
      await refreshUser();
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=> signOut(auth));
    document.getElementById('adminBtn').addEventListener('click', ()=> location.href='admin.html');

    // history loader
    async function loadHistory(){
      const logs = [];
      // get transactions
      const txSnap = await getDocs(query(collection(db,'transactions'), where('userId','==', currentUserUid)));
      txSnap.forEach(s => logs.push(s.data()));
      // withdraw requests for this user
      const wr = await getDocs(query(collection(db,'withdrawRequests'), where('userId','==', currentUserUid), orderBy('createdAt','desc')));
      wr.forEach(s => logs.push(s.data()));
      const hist = document.getElementById('history');
      hist.innerHTML = '';
      logs.slice().reverse().forEach(it => {
        const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #123';
        el.innerHTML = `<div style="font-size:14px">${it.type||it.status||'entry'} — ${it.amount ? it.amount+'৳' : ''} <div style="color:#9fb7bf;font-size:12px">${it.note || it.status || ''}</div></div>`;
        hist.appendChild(el);
      });
    }
  </script>
</body>
</html>