<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel</title>
  <style>body{font-family:Arial;background:#071228;color:#fff;padding:12px} .card{background:#0f2b3b;padding:10px;border-radius:8px;margin-bottom:10px}</style>
</head>
<body>
  <h2>Admin — Withdraw Requests</h2>
  <div id="list"></div>

  <script type="module">
    import { auth, db, onAuthStateChanged } from "./firebase.js";
    import { collection, getDocs, query, where, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    // check admin role (we will require users/{uid}.role === 'admin')
    onAuthStateChanged(auth, async user => {
      if(!user) return location.href = 'index.html';
      const uDoc = await getDoc(doc(db,'users',user.uid));
      const role = uDoc.exists() ? uDoc.data().role : null;
      if(role !== 'admin') return alert('Not an admin');
      loadRequests();
    });

    async function loadRequests(){
      const q = query(collection(db,'withdrawRequests'), where('status','==','pending'));
      const snap = await getDocs(q);
      const list = document.getElementById('list'); list.innerHTML = '';
      snap.forEach(s => {
        const d = s.data();
        const id = s.id;
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `<div><b>${d.email}</b> wants ${d.amount} ৳ — <small>${d.createdAt?.toDate? d.createdAt.toDate() : ''}</small></div>
          <div style="margin-top:8px">
            <button onclick="approve('${id}')">Approve & Mark Paid</button>
            <button onclick="reject('${id}')" style="margin-left:8px;background:#ef4444">Reject</button>
          </div>`;
        list.appendChild(el);
      });
    }

    window.approve = async (id) => {
      // mark withdraw request paid + deduct balance + create transaction
      const reqRef = doc(db,'withdrawRequests',id);
      const reqSnap = await getDoc(reqRef);
      const req = reqSnap.data();
      if(!req) return alert('Not found');
      // deduct from user's balance
      const uRef = doc(db,'users', req.userId);
      const uSnap = await getDoc(uRef);
      const bal = uSnap.data().balance || 0;
      // if balance is insufficient, admin can still mark paid (or reject)
      await updateDoc(reqRef, { status:'approved', approvedAt: serverTimestamp() });
      // deduct
      await updateDoc(uRef, { balance: Math.max(0, bal - req.amount) });
      // add a transaction record
      await addDoc(collection(db,'transactions'), { userId: req.userId, amount: req.amount, type:'withdraw', note:'paid by admin', createdAt: serverTimestamp() });
      alert('Approved & marked paid');
      loadRequests();
    };

    window.reject = async (id) => {
      await updateDoc(doc(db,'withdrawRequests',id), { status:'rejected' });
      alert('Rejected');
      loadRequests();
    };
  </script>
</body>
</html>